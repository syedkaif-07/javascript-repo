<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="style.css">
  <title>Calculator</title>
  
</head>
<body>
  <div class="calculator" role="application" aria-label="Calculator">
    <div class="display" aria-live="polite">
      <div class="sub" id="expression">0</div>
      <div class="main" id="result">0</div>
    </div>

    <div class="keys">
      <button class="btn-op" data-action="clear" title="Clear">C</button>
      <button class="btn-op" data-action="plusminus" title="Plus / Minus">±</button>
      <button class="btn-op" data-action="percent" title="Percent">%</button>
      <button class="btn-op" data-action="backspace" title="Backspace">⌫</button>

      <button data-value="7">7</button>
      <button data-value="8">8</button>
      <button data-value="9">9</button>
      <button class="btn-op" data-value="/">÷</button>

      <button data-value="4">4</button>
      <button data-value="5">5</button>
      <button data-value="6">6</button>
      <button class="btn-op" data-value="*">×</button>

      <button data-value="1">1</button>
      <button data-value="2">2</button>
      <button data-value="3">3</button>
      <button class="btn-op" data-value="-">−</button>

      <button class="btn-wide" data-value="0">0</button>
      <button data-value=".">.</button>
      <button class="btn-eq" data-action="equals">=</button>
    </div>
  </div>

  <script>
    (function(){
      const expressionEl = document.getElementById('expression');
      const resultEl = document.getElementById('result');
      const keys = document.querySelectorAll('button');

      let expr = '';
      let lastIsResult = false;

      function updateDisplay(){
        expressionEl.textContent = expr || '0';
        resultEl.textContent = expr || '0';
      }

      function appendValue(val){
        if(lastIsResult && /[0-9.]/.test(val)){
          // start new expression when number typed after result
          expr = '';
          lastIsResult = false;
        }

        // Prevent multiple decimals in a number
        if(val === '.'){
          // find last token
          const tokens = expr.split(/([+\-*/])/).filter(Boolean);
          const last = tokens[tokens.length-1] || '';
          if(last.includes('.')) return;
          if(last === '' ) val = '0.'; // leading decimal
        }

        // Prevent consecutive operators
        if(/[+\-*/]/.test(val)){
          if(expr === '') return; // can't start with operator except minus
          if(/[+\-*/]$/.test(expr)){
            // replace last operator
            expr = expr.slice(0,-1) + val;
            updateDisplay();
            lastIsResult = false;
            return;
          }
        }

        expr += val;
        updateDisplay();
      }

      function clearAll(){ expr = ''; updateDisplay(); lastIsResult=false }

      function backspace(){
        if(expr.length>0){ expr = expr.slice(0,-1); updateDisplay(); }
      }

      function togglePlusMinus(){
        if(expr === '') return;
        // toggle sign of last number
        const tokens = expr.split(/([+\-*/])/);
        let i = tokens.length - 1;
        // find last number token (may include decimal)
        while(i>=0 && /[+\-*/]/.test(tokens[i])) i--;
        if(i<0) return;
        let num = tokens[i];
        if(num.startsWith('-')) num = num.slice(1);
        else num = '-' + num;
        tokens[i] = num;
        expr = tokens.join('');
        updateDisplay();
      }

      function applyPercent(){
        if(expr === '') return;
        // transform last number into percentage of previous or just divide by 100
        const tokens = expr.split(/([+\-*/])/).filter(Boolean);
        let last = tokens.pop();
        if(last === undefined) return;
        // compute percent of previous value if operator exists
        const prev = tokens.join('');
        try{
          const val = parseFloat(last);
          if(isNaN(val)) return;
          const percentVal = (val/100).toString();
          expr = prev ? prev + percentVal : percentVal;
          updateDisplay();
        }catch(e){/* ignore */}
      }

      function compute(){
        if(expr === '') return;
        // avoid trailing operator
        if(/[+\-*/]$/.test(expr)) expr = expr.slice(0,-1);
        try{
          // replace × ÷ symbols (we use * and / already)
          const safeExpr = expr.replace(/[^0-9.+\-*/()]/g, '');
          // Use Function for evaluation (local only). Be careful with user input in other contexts.
          const value = Function('return (' + safeExpr + ')')();
          expr = String(Number.isFinite(value) ? +(+value.toFixed(12)) : value);
          updateDisplay();
          lastIsResult = true;
        }catch(e){
          resultEl.textContent = 'Error';
        }
      }

      keys.forEach(btn => {
        const v = btn.getAttribute('data-value');
        const action = btn.getAttribute('data-action');
        btn.addEventListener('click', ()=>{
          if(action){
            if(action === 'clear') clearAll();
            else if(action === 'backspace') backspace();
            else if(action === 'plusminus') togglePlusMinus();
            else if(action === 'percent') applyPercent();
            else if(action === 'equals') compute();
          } else if(v){
            appendValue(v);
          }
        });
      });

      // Keyboard support
      window.addEventListener('keydown', (ev)=>{
        if(ev.key === 'Enter') { ev.preventDefault(); compute(); return; }
        if(ev.key === 'Backspace'){ ev.preventDefault(); backspace(); return; }
        if(ev.key === 'Escape'){ clearAll(); return; }
        if(ev.key === '%'){ applyPercent(); return; }
        if(ev.key === '.') { appendValue('.'); return; }
        if(/[0-9]/.test(ev.key)){ appendValue(ev.key); return; }
        if(ev.key === '+'|| ev.key === '-'|| ev.key === '*'|| ev.key === '/') { appendValue(ev.key); return; }
      });

      // init
      updateDisplay();
    })();
  </script>
</body>
</html>
